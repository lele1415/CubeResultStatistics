<Html>
<Head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<Title>666</Title>
</Head>
<Body bgcolor="#FFFFFF">

url:<input type="text" id="url">
<input type="button" id="getCode_id" onclick="getPagesCode()" value="Get code" />
<br>
<input type="button" id="getCode_id" onclick="getTextFromCode(0)" value="Get results" />
<br>
<input type="button" id="getCodeTest_id" onclick="writeReslutsToExcel()" value="Write results" />
<br>
<input type="input" id="floorNumInput_id" />
<select id="inputProjectName_id">"333","444","555","222","333bf","333oh","333fm","mega","py","sq","clock","sk","666","777"
    <option value="333">333</option>
    <option value="444">444</option>
    <option value="555">555</option>
    <option value="222">222</option>
    <option value="333bf">333bf</option>
    <option value="333oh">333oh</option>
    <option value="333fm">333fm</option>
    <option value="mega">mega</option>
    <option value="py">py</option>
    <option value="sq">sq</option>
    <option value="clock">clock</option>
    <option value="sk">sk</option>
    <option value="666">666</option>
    <option value="777">777</option>
</select>
<input type="button" id="fewResultsTest_id" onclick="fewResultsTest()" value="Test result" />
<input type="button" id="inputResult_id" onclick="inputResult()" value="Input result" />
<br>
<br>
<p>楼层: <b id="floorNum_id"></b></p> 

<Script Language="JavaScript"> 

//用于创建XMLHttpRequest对象 
function createXmlHttp() { 
    //根据window.XMLHttpRequest对象是否存在使用不同的创建方式 
    if (window.XMLHttpRequest) { 
        xmlHttp = new XMLHttpRequest(); //FireFox、Opera等浏览器支持的创建方式 
    } else { 
        xmlHttp = new ActiveXObject("Microsoft.XMLHTTP");//IE浏览器支持的创建方式 
    } 
} 

function getUrl() {
    var url = document.getElementById("url").value;
    return url;
}

//直接通过XMLHttpRequest对象获取远程网页源代码 
function getSource(url) { 
    //document.getElementById("source").value = "正在加载……"; //提示正在加载 
    createXmlHttp(); //创建XMLHttpRequest对象 
    xmlHttp.onreadystatechange = writeSource; //设置回调函数 
    xmlHttp.open("GET", url, true); 
    xmlHttp.send(null); 
} 

//将远程网页源代码写入页面文字区域 
function writeSource() { 
    if (xmlHttp.readyState == 4) { 
        //document.getElementById("source").value = xmlHttp.responseText; 
        writeToTxt(xmlHttp.responseText);
    } 
} 

function setFloorNumForShow(floorNum) {
    document.getElementById("floorNum_id").innerHTML = floorNum;
}

function getFloorNumForTest() {
    return document.getElementById("floorNumInput_id").value;
}

function getInputProjectName() {
    return document.getElementById("inputProjectName_id").value;
}
</Script>
<Script Language="VBScript">

Dim width,height
width=CreateObject("HtmlFile").ParentWindow.Screen.AvailWidth
Window.MoveTo width-400,300
Window.ResizeTo 400,240

Dim ws, Fso, codeTxtPath, floorData(), userNameData(), projectData(), resultData(), countResultData, avgResultData(), bestResultData()
Set ws=CreateObject("wscript.shell")
Set Fso=CreateObject("Scripting.FileSystemObject")
codeTxtPath = ws.CurrentDirectory&"\temp.txt"
resultTxtPath = ws.CurrentDirectory&"\result.txt"
noResultTxtPath = ws.CurrentDirectory&"\noResult.txt"
countResultData = 0
Dim floorDataNoResult(), userNameDataNoResult(), projectDataNoResult(), countNoResultData
countNoResultData = 0
Dim userNameData_333, resultData_333
Dim userNameData_444, resultData_444
Dim userNameData_555, resultData_555
Dim userNameData_222, resultData_222
Dim userNameData_333bf, resultData_333bf
Dim userNameData_333oh, resultData_333oh
Dim userNameData_333fm, resultData_333fm
Dim userNameData_py, resultData_py
Dim userNameData_mega, resultData_mega
Dim userNameData_sq, resultData_sq
Dim userNameData_clock, ResultData_clock
Dim userNameData_sk, resultData_sk
Dim userNameData_666, resultData_666
Dim userNameData_777, resultData_777
Dim countExcelRow
countExcelRow = 0
Dim debug, inputFlag
debug = False
inputFlag = False

Sub Sleep(MSecs)  
    Dim fso
    Dim objOutputFile

    Set fso = CreateObject("Scripting.FileSystemObject") 
    If Fso.FileExists("sleeper.vbs")=False Then 
        Set objOutputFile = fso.CreateTextFile("sleeper.vbs", True) 
        objOutputFile.Write "wscript.sleep WScript.Arguments(0)" 
        objOutputFile.Close 
    End If 
     CreateObject("WScript.Shell").Run "sleeper.vbs " & MSecs,1 , True 
End Sub

Function fewResultsTest()
    debug = True
    getTextFromCode(1)
End Function

Function inputResult()
    inputFlag = True
    getTextFromCode(1)
End Function




'*************************************************
'****get code from Pages, and write into text file.
'*************************************************
Function getPagesCode()
    checkTxtFile(codeTxtPath)
    getSource(getUrl())
    Sleep(1000)

    Dim MaxPage, url, i
    MaxPage = getInfoFromTxt("尾页", "pn=", 3, "尾页", -2)
    For i = 2 To MaxPage
        url = getUrl() & "?pn=" & i
        getSource(url)
        Sleep(1000)
    Next
    'Sleep(1000)
    'getTextFromCode(0)
    Msgbox("Done!")
End Function

        Function checkTxtFile(FilePath)
            If Fso.FileExists(FilePath) Then
                Dim TxtFile
                Set TxtFile = Fso.getFile(FilePath)
                TxtFile.Delete
                Set TxtFile = Nothing
            End If    
            Fso.CreateTextFile FilePath, True
        End Function

        Function writeToTxt(responseText)
            Set oTxt = Fso.OpenTextFile(codeTxtPath,8)
            oTxt.Write(responseText)
            oTxt.Close
            Set oTxt = Nothing
        End Function

        Function getInfoFromTxt(strSearch, strStart, numStart, strEnd, numEnd)
            Dim oTxt, getStrLine, MaxPage
            Set oTxt = Fso.OpenTextFile(codeTxtPath,1)

            Do Until oTxt.AtEndOfStream
                getStrLine = oTxt.ReadLine
                If InStr(getStrLine,strSearch) > 0 Then
                    Exit Do
                End If
            Loop
            Set oTxt = Nothing
            countStart = InStr(getStrLine,strStart) + numStart
            countEnd = InStr(getStrLine,strEnd) + numEnd
            'Msgbox(countStart & " " & countEnd)
            getInfoFromTxt = Mid(getStrLine, countStart, countEnd-countStart)
        End Function



'*************************************************
'****get origin Str from Code for deal.
'*************************************************
Function getTextFromCode(testFlag)
    Dim tmpStrResult, strResult, strUserName, countStart
    tmpStrResult = getArrayFromTxt("j_d_post_content", "j_d_post_content", 40, "user-hide-post-down", -31)
    strResult = checkStrArrayForBubble(tmpStrResult)
    strUserName = getArrayFromTxt("p_author_name", "_blank", 8, "</a>", 0)
    strFloorNum = getShortStrFromTxt("post_no&quot", "post_no&quot", 14, 4, ",")
    If testFlag = 0 Then
        For i = 0 to UBound(strUserName)
            If (strUserName(i) = "魔方英语会计学") AND (Instr(strResult(i),"--完--") > 0) Then
                countStart = i + 1
                Exit For
            End If
        Next
    Else
        For i = 0 to UBound(strUserName)
            If strFloorNum(i) = getFloorNumForTest() Then
                countStart = i
                Exit For
            End If
        Next
    End If

    'For i = countStart+1 To UBound(strUserName)
        'msgbox(strUserName(i) & vbLf & strResult(i))
    'Next
    dealOriginStr strResult, strUserName, strFloorNum, countStart
End Function

        Function getArrayFromTxt(strSearch, strStart, numStart, strEnd, numEnd)
            Dim oTxt, getStrLine, MaxPage, strArray(), count
            Set oTxt = Fso.OpenTextFile(codeTxtPath,1)
            count = 0
            Do Until oTxt.AtEndOfStream
                getStrLine = oTxt.ReadLine
                If InStr(getStrLine,strSearch) > 0 Then
                    ReDim Preserve strArray(count)
                    countStart = InStr(getStrLine,strStart) + numStart
                    countEnd = InStr(getStrLine,strEnd) + numEnd
                    If (countStart > 0 And countEnd > 0) Then
                        strArray(count) = Mid(getStrLine, countStart, countEnd-countStart)
                        count = count + 1
                    'Else
                        'Msgbox(countStart & " " & countEnd & vbLf & getStrLine)
                    End If
                End If
            Loop
            Set oTxt = Nothing
            getArrayFromTxt = strArray
        End Function

        Function checkStrArrayForBubble(strArray)
            Dim tmpArray(), tmpStr
            For i = 0 To UBound(strArray)
                tmpStr = strArray(i)
                If InStr(tmpStr,"post_bubble_middle") > 0 Then
                    tmpStr = cutStrWithKey(tmpStr, "post_bubble_middle", 18, "post_bubble_bottom", 0)
                    tmpStr = cutStrWithKey(tmpStr, "png", 6, "</div>", 0)
                End If

                ReDim Preserve tmpArray(i)
                tmpArray(i) = tmpStr
            Next
            checkStrArrayForBubble = tmpArray
        End Function

        Function getShortStrFromTxt(strSearch, strStart, numStart, strLen, strEnd)
            Dim oTxt, getStrLine, MaxPage, strArray(), count
            Set oTxt = Fso.OpenTextFile(codeTxtPath,1)
            count = 0
            Do Until oTxt.AtEndOfStream
                getStrLine = oTxt.ReadLine
                If InStr(getStrLine,strSearch) > 0 Then
                    ReDim Preserve strArray(count)
                    countStart = InStr(getStrLine,strStart) + numStart
                    'Msgbox(countStart & " " & countEnd)
                    tmpStr = Mid(getStrLine, countStart, strLen)
                    countEnd = InStr(tmpStr, strEnd)
                    if countEnd > 0 Then 
                        strArray(count) = Mid(tmpStr, 1, countEnd-1)
                        count = count + 1
                    End If
                End If
            Loop
            Set oTxt = Nothing
            getShortStrFromTxt = strArray
        End Function



'*************************************************
'****deal origin Str.
'*************************************************
Function dealOriginStr(strResultArray, strUserNameArray, strFloorNum, countStart)
    If Not inputFlag Then
        checkTxtFile(resultTxtPath)
        checkTxtFile(noResultTxtPath)
    End If
    Dim allProjectArray, seqProjectInStr, flag

    If Not inputFlag Then
        For i = countStart To UBound(strResultArray)
            setFloorNumForShow(strFloorNum(i))
            allProjectArray = getAllProjectName()
            flag = True
            For j = 0 To UBound(allProjectArray)
                seqProjectInStr = getSeqOfProjectInStr(strResultArray(i), allProjectArray(j))
                If seqProjectInStr <> "" Then
                    getAndDealResult strResultArray(i), strUserNameArray(i), strFloorNum(i), seqProjectInStr, allProjectArray(j)
                    flag = False
                End If
            Next
            If flag Then
                getAndDealResult strResultArray(i), strUserNameArray(i), strFloorNum(i), "", ""
            End If

            if debug Then
                Exit For
            End If
        Next
    Else
        getAndDealResult strResultArray(countStart), strUserNameArray(countStart), strFloorNum(countStart), 1, getInputProjectName()
    End If

    'writeReslutsToExcel()
    Msgbox("OK")
End Function

        Function getSeqOfProjectInStr(str, projectName)
            Dim seqFinal, tmpStr, checkStrArray, seqInStr
            seqFinal = ""
            tmpStr = LCase(str)
            checkStrArray = getProjectCheckStrArray(projectName)

            If IsNumeric(projectName) Then
                tmpStr = "beginFlag" & tmpStr
            End If
            
            For i = 0 To UBound(checkStrArray)
                seqInStr = InStr(tmpStr, checkStrArray(i))
                If seqInStr > 0 Then
                    seqFinal = seqInStr + Len(checkStrArray(i))
                    Exit For
                End If
            Next

            If IsNumeric(projectName) And (seqFinal <> "") Then
                seqFinal = seqFinal - 9
            End If

            getSeqOfProjectInStr = seqFinal
        End Function



'*************************************************
'****get result.
'*************************************************
Function getAndDealResult(str, strUserName, floorNum, countCheck, projectName)
    If countCheck <> "" Then
        Dim finalResultArray, strResult, j, numResult, avgResult, bestResult
        strResult = ""
        numResult = 5

        If (projectName = "333bf") Or (projectName = "333fm") Or (projectName = "666") Or (projectName = "777") Then
            numResult = 3
        End If

        if debug Then
            Msgbox(str)
            Msgbox(countCheck)
        End If
        finalResultArray = getArrayResult(str, countCheck, numResult, projectName)

        If UBound(finalResultArray) > 0 Then
            avgAndBestResult = getAvgAndBestResult(finalResultArray)
            avgResult = avgAndBestResult(0)
            bestResult = avgAndBestResult(1)

            If projectName = "333fm" Then
                bestResult = FormatNumber(bestResult, 0, , , 0)
            End If

            strResult = avgResult & " " & bestResult

            For j = 0 To UBound(finalResultArray)
                strResult = strResult & " " & finalResultArray(j)
            Next

            strResult = Trim(strResult)
        Else
            avgResult = ""
            bestResult = ""
            strResult = ""
        End If

        saveResult str, strResult, strUserName, floorNum, projectName
    Else
        saveResult str, "", strUserName, floorNum, ""
    End If
End Function

        Function getArrayResult(str, countCheck, numResult, projectName)
            Dim resultArray
            If projectName <> "333fm" Then
                resultArray = getFiveResult(str, countCheck, numResult)
            Else
                resultArray = getFmResult(str, countCheck)
            End If
            getArrayResult = resultArray
        End Function

        Function getAvgAndBestResult(strArray)
            Dim tmpArray,avgAndBestResult(1)
            tmpArray = strArray

            For i = 0 To UBound(tmpArray)
                tmpArray(i) = changeResult(tmpArray(i))
            Next

            tmpArray = sortIntArray(tmpArray)
            If UBound(tmpArray) = 4 Then
                If tmpArray(3) <> 9999.99 Then
                    avgAndBestResult(0) = Round(((0 + tmpArray(1) + tmpArray(2) + tmpArray(3)) / 3), 2)
                Else
                    avgAndBestResult(0) = 9999.99
                End If
                avgAndBestResult(1) = tmpArray(0)
            Else
                If tmpArray(2) <> 9999.99 Then
                    avgAndBestResult(0) = Round(((0 + tmpArray(0) + tmpArray(1) + tmpArray(2)) / 3), 2)
                Else
                    avgAndBestResult(0) = 9999.99
                End If
                avgAndBestResult(1) = tmpArray(0)
            End If

            avgAndBestResult(0) = FormatNumber(avgAndBestResult(0), 2, , , 0)

            For i = 0 To UBound(avgAndBestResult)
                avgAndBestResult(i) = revertResult(avgAndBestResult(i))
            Next

            getAvgAndBestResult = avgAndBestResult
        End Function

        Function getFiveResult(str, countStart, numResult)
            Dim tmpStr, tmpCountStart, SimpleStr, resultArray(), countGetedResult, result(4,3), tmpStep, tmpStepResult, stepResult(4)
            ReDim Preserve resultArray(0)
            countGetedResult = 0
            tmpStepResult = 0
            tmpStr = str
            tmpCountStart = countStart
            inStrCount = InStr(tmpStr, "成绩列表")
            If inStrCount > 0 Then
                tmpStr = Mid(tmpStr, inStrCount)
                tmpCountStart = 1
            End If
            SimpleStr = changeStrToSimple(Mid(tmpStr, tmpCountStart))
            dnfStep = getAllStepInStr(SimpleStr, "D0.00")
            tmpStep = getAllStepInStr(SimpleStr, "0.00")
            If debug Then
                Msgbox(tmpStr)
                Msgbox(SimpleStr)
                msgboxArray(tmpStep)
            End If
            If UBound(tmpStep) >= numResult-1 Then
                tmpStep = getCloseNumArray(tmpStep, numResult)
                If debug Then
                    msgboxArray(tmpStep)
                End If
                If UBound(tmpStep) > 0 Then
                    '//'modified tmpStep For DNF
                    If dnfStep(0) <> "" Then
                        For k = UBound(dnfStep) To 0 Step -1
                            For l = 0 To UBound(tmpStep)
                                If tmpStep(l)-1 = dnfStep(k) Then
                                    tmpStep(l) = dnfStep(k)
                                ElseIf tmpStep(l)-2 > dnfStep(k) Then
                                    tmpStep(l) = tmpStep(l) - 2
                                End If
                            Next
                        Next
                    End If

                    '//'get result with tmpStep
                    For i = 0 To UBound(tmpStep)
                        ReDim Preserve resultArray(i)
                        tmpStep(i) = tmpStep(i) + tmpCountStart - 1
                        resultArray(i) = Mid(tmpStr, tmpStep(i), 4)
                        If isCharacter(Mid(tmpStr, tmpStep(i), 1), "Dd") Then
                            resultArray(i) = "DNF"
                        Else
                            If tmpStep(i) > 3 Then
                                num1 = Mid(tmpStr, tmpStep(i)-3, 1)
                                num2 = Mid(tmpStr, tmpStep(i)-2, 1)
                                num3 = Mid(tmpStr, tmpStep(i)-1, 1)
                            ElseIf tmpStep(i) > 1 Then
                                num3 = Mid(tmpStr, tmpStep(i)-1, 1)
                            End If

                            If IsNumeric(num3) Then
                                resultArray(i) = num3 & resultArray(i)
                                If isCharacter(num2, ":：") And IsNumeric(num1) Then
                                    resultArray(i) = num1 & num2 & resultArray(i)
                                End If
                            End If
                        End If
                    Next
                End If
            End If
            If debug Then
                msgboxArray(resultArray)
            End If
            getFiveResult = resultArray
        End Function

        Function changeStrToSimple(str)
            Dim tmpStr, simpleStr
            tmpStr = str
            simpleStr = ""
            For searchStep = 1 To Len(tmpStr)
                Select Case True
                    Case IsNumeric(Mid(tmpStr, searchStep, 1))
                        simpleStr = simpleStr & "0"
                    Case isCharacter(Mid(tmpStr, searchStep, 1), "Dd")
                        simpleStr = simpleStr & "D"
                    Case isCharacter(Mid(tmpStr, searchStep, 1), "Nn")
                        simpleStr = simpleStr & "N"
                    Case isCharacter(Mid(tmpStr, searchStep, 1), "Ff")
                        simpleStr = simpleStr & "F"
                    Case isCharacter(Mid(tmpStr, searchStep, 1), ".。")
                        simpleStr = simpleStr & "."
                    Case isCharacter(Mid(tmpStr, searchStep, 1), ":：")
                        simpleStr = simpleStr & ":"
                    Case Else
                        simpleStr = simpleStr & "_"
                End Select
            Next
            simpleStr = RePlace(simpleStr, "DNF", "D0.00")
            changeStrToSimple = simpleStr
        End Function

        Function getAllStepInStr(str1, str2)
            Dim count, stepArray(), tmpStr1, tmpStr2
            count = 0
            tmpStr1 = str1
            tmpStr2 = str2
            If InStr(tmpStr1, tmpStr2) > 0 Then
                Do Until Not (InStr(tmpStr1, tmpStr2) > 0)
                    ReDim Preserve stepArray(count)
                    stepArray(count) = InStr(tmpStr1, tmpStr2) + count * Len(tmpStr2)
                    tmpStr1 = RePlace(tmpStr1, tmpStr2, "", 1, 1)
                    count = count + 1
                Loop
                getAllStepInStr = stepArray
            Else
                ReDim Preserve stepArray(0)
                getAllStepInStr = stepArray
            End If
        End Function

        Function getCloseNumArray(intArray, numResult)
            'Dim intArray, diffNum, numResult
            'intArray = Array(1,5,8,15,16,17,25,34,54,55,56,57)
            'diffNum = 1
            'numResult = 5
            Dim i, j, diffStepArray1, diffStepArray2, newArray(), finalArray
            j = 2
            diffStepArray1 = getDiffStepArray(intArray)
            diffStepArray2 = getDiffStepArray(diffStepArray1)
            Redim Preserve newArray(1)
            newArray(0) = intArray(0)
            newArray(1) = intArray(1)
            For i = 0 To UBound(diffStepArray2)
                If j = numResult Then
                    Exit For
                End If
                
                If Abs(diffStepArray2(i)) <= 3  Then
                    Redim Preserve newArray(j)
                    newArray(j) = intArray(i+2)
                    j = j + 1
                Else
                    j = 2
                    newArray(0) = intArray(i+1)
                    newArray(1) = intArray(i+2)
                End If
            Next
            If j = numResult Then
                    finalArray = newArray
            Else
                Redim Preserve newArray(0)
                finalArray = newArray
            End If
            getCloseNumArray = finalArray
            'msgboxArray(finalArray)
        End Function

                Function getDiffStepArray(intArray)
                    Dim tmpArray()
                    For i = 0 To UBound(intArray)-1
                        ReDim Preserve tmpArray(i)
                        tmpArray(i) = intArray(i+1) - intArray(i)
                    Next
                    getDiffStepArray = tmpArray
                End Function

        Function getFmResult(str, countStart)
            Dim countFm, strTmp1, strTmp2, fmResult(2), countGetedResult, searchStep, searchStepResult(2), tmpFmResult
            countFm = ""
            countGetedResult = 0
            searchStep = 0
            
            Do Until (countGetedResult = 3) Or (searchStep > 20)
                strTmp1 = Mid(str, countStart+searchStep+1, 1)
                strTmp2 = Mid(str, countStart+searchStep+2, 1)
                If IsNumeric(strTmp1) And IsNumeric(strTmp2) Then
                    fmResult(countGetedResult) = strTmp1 & strTmp2
                    searchStepResult(countGetedResult) = countStart + searchStep + 1
                    searchStep = searchStep + 2
                    If countGetedResult > 0 Then
                        If searchStepResult(countGetedResult) - searchStepResult(countGetedResult-1) > 6 Then
                            fmResult(countGetedResult) = ""
                            Exit Do
                        Else
                            countGetedResult = countGetedResult + 1
                        End If
                    Else
                        countGetedResult = countGetedResult + 1
                    End If
                Else
                    searchStep = searchStep + 1
                End If
            Loop

            If countGetedResult <> 3 Then
                tmpFmResult = getFmResultSpecial(str, countStart)
                If (tmpFmResult(2) <> "") Then
                    getFmResult = tmpFmResult
                ElseIf (tmpFmResult(1) <> "") And (countGetedResult < 2) Then
                    getFmResult = tmpFmResult
                ElseIf (tmpFmResult(0) <> "") And (countGetedResult < 1) Then
                    getFmResult = tmpFmResult
                Else
                    getFmResult = fmResult
                End If
            Else
                getFmResult = fmResult
            End If
        End Function

        Function getFmResultSpecial(str, countStart)
            Dim countFm, strTmp1, strTmp2, fmResult(2), countGetedResult, searchStep
            countFm = 0
            countGetedResult = 0
            searchStep = 0

            Select Case True
                Case InStr(countStart, str, "Total steps") > 0
                    countFm = InStr(countStart, str, "Total steps")
            End Select

            Do Until (Not countFm > 0) Or (countGetedResult = 3) Or (searchStep > Len(str)-countFm-2)
                strTmp1 = Mid(str, countFm+searchStep+1, 1)
                strTmp2 = Mid(str, countFm+searchStep+2, 1)
                If IsNumeric(strTmp1) And IsNumeric(strTmp2) Then
                    fmResult(countGetedResult) = strTmp1 & strTmp2
                    countGetedResult = countGetedResult + 1
                    countFm = InStr(countFm+11, str, "Total steps")
                    searchStep = 0
                End If
                searchStep = searchStep + 1
            Loop
            getFmResultSpecial = fmResult
        End Function



'*************************************************
'****save result into text file.
'*************************************************
Function saveResult(str, strResult, strUserName, floorNum, projectName)
    Dim oTxt
    If strResult <> "" Then
        Set oTxt = Fso.OpenTextFile(resultTxtPath, 8)

        ReDim Preserve floorData(countResultData)
        ReDim Preserve userNameData(countResultData)
        ReDim Preserve projectData(countResultData)
        ReDim Preserve resultData(countResultData)
        floorData(countResultData) = floorNum & "楼"
        userNameData(countResultData) = strUserName
        projectData(countResultData) = projectName
        resultData(countResultData) = strResult

        oTxt.WriteLine(floorData(countResultData))
        oTxt.WriteLine(str)
        oTxt.WriteLine(userNameData(countResultData))
        oTxt.WriteLine(projectData(countResultData))
        oTxt.WriteLine(resultData(countResultData))
        oTxt.WriteLine()
        oTxt.WriteLine()

        countResultData = countResultData + 1
    Else
        Set oTxt = Fso.OpenTextFile(noResultTxtPath, 8)
        ReDim Preserve floorDataNoResult(countNoResultData)
        ReDim Preserve userNameDataNoResult(countNoResultData)
        ReDim Preserve projectDataNoResult(countNoResultData)
        floorDataNoResult(countNoResultData) = floorNum & "楼"
        userNameDataNoResult(countNoResultData) = strUserName
        projectDataNoResult(countNoResultData) = projectName

        oTxt.WriteLine(floorDataNoResult(countNoResultData))
        oTxt.WriteLine(str)
        oTxt.WriteLine(userNameDataNoResult(countNoResultData))
        oTxt.WriteLine(projectDataNoResult(countNoResultData))
        oTxt.WriteLine()
        oTxt.WriteLine()
    End If
    Set oTxt = Nothing
End Function



'*************************************************
'****write final result into excel file.
'*************************************************
Function writeReslutsToExcel()
    sortByProject()

    sortByAvgResult userNameData_333, resultData_333, 0
    sortByAvgResult userNameData_444, resultData_444, 0
    sortByAvgResult userNameData_555, resultData_555, 0
    sortByAvgResult userNameData_222, resultData_222, 0
    sortByAvgResult userNameData_333bf, resultData_333bf, 1
    sortByAvgResult userNameData_333oh, resultData_333oh, 0
    sortByAvgResult userNameData_333fm, resultData_333fm, 0
    sortByAvgResult userNameData_py, resultData_py, 0
    sortByAvgResult userNameData_mega, resultData_mega, 0
    sortByAvgResult userNameData_sq, resultData_sq, 0
    sortByAvgResult userNameData_clock, resultData_clock, 0
    sortByAvgResult userNameData_sk, resultData_sk, 0
    sortByAvgResult userNameData_666, resultData_666, 0
    sortByAvgResult userNameData_777, resultData_777, 0

    Dim ExcelApp, ExcelBook, ExcelSheet
    Set ExcelApp = CreateObject("Excel.Application")
    Set ExcelBook= ExcelApp.Workbooks.Open(ws.CurrentDirectory&"\result.xlsx")
    Set ExcelSheet = ExcelBook.Sheets("Sheet1")

    writeAllProjectResult ExcelSheet, userNameData_333, resultData_333, "333"
    writeAllProjectResult ExcelSheet, userNameData_444, resultData_444, "444"
    writeAllProjectResult ExcelSheet, userNameData_555, resultData_555, "555"
    writeAllProjectResult ExcelSheet, userNameData_222, resultData_222, "222"
    writeAllProjectResult ExcelSheet, userNameData_333bf, resultData_333bf, "333bf"
    writeAllProjectResult ExcelSheet, userNameData_333oh, resultData_333oh, "333oh"
    writeAllProjectResult ExcelSheet, userNameData_333fm, resultData_333fm, "333fm"
    writeAllProjectResult ExcelSheet, userNameData_py, resultData_py, "py"
    writeAllProjectResult ExcelSheet, userNameData_mega, resultData_mega, "mega"
    writeAllProjectResult ExcelSheet, userNameData_sq, resultData_sq, "sq"
    writeAllProjectResult ExcelSheet, userNameData_clock, resultData_clock, "clock"
    writeAllProjectResult ExcelSheet, userNameData_sk, resultData_sk, "sk"
    writeAllProjectResult ExcelSheet, userNameData_666, resultData_666, "666"
    writeAllProjectResult ExcelSheet, userNameData_777, resultData_777, "777"

    ExcelBook.Save
    ExcelBook.Close
    ExcelApp.Quit
    Set ExcelSheet = Nothing
    Set ExcelBook = Nothing
    Set ExcelApp = Nothing
    Msgbox("Write done!")
End Function

        Function sortByProject()
            Dim allProjectArray, tmpUserNameData(), tmpResultData()
            allProjectArray = getAllProjectName()
            count = 0
            

            For i = 0 To UBound(allProjectArray)
                ReDim Preserve tmpUserNameData(0)
                ReDim Preserve tmpResultData(0)
                tmpUserNameData(0) = ""
                tmpResultData(0) = ""
                count = 0

                For j = 0 To UBound(userNameData)
                    If projectData(j) = allProjectArray(i) Then
                        ReDim Preserve tmpUserNameData(count)
                        ReDim Preserve tmpResultData(count)
                        tmpUserNameData(count) = userNameData(j)
                        tmpResultData(count) = resultData(j)
                        count = count + 1
                    End If
                Next

                Select Case allProjectArray(i)
                    Case "333"
                        userNameData_333 = tmpUserNameData
                        resultData_333 = tmpResultData
                    Case "444"
                        userNameData_444 = tmpUserNameData
                        resultData_444 = tmpResultData
                    Case "555"
                        userNameData_555 = tmpUserNameData
                        resultData_555 = tmpResultData
                    Case "222"
                        userNameData_222 = tmpUserNameData
                        resultData_222 = tmpResultData
                    Case "333bf"
                        userNameData_333bf = tmpUserNameData
                        resultData_333bf = tmpResultData
                    Case "333oh"
                        userNameData_333oh = tmpUserNameData
                        resultData_333oh = tmpResultData
                    Case "333fm"
                        userNameData_333fm = tmpUserNameData
                        resultData_333fm = tmpResultData
                    Case "py"
                        userNameData_py = tmpUserNameData
                        resultData_py = tmpResultData
                    Case "mega"
                        userNameData_mega = tmpUserNameData
                        resultData_mega = tmpResultData
                    Case "sq"
                        userNameData_sq = tmpUserNameData
                        resultData_sq = tmpResultData
                    Case "clock"
                        userNameData_clock = tmpUserNameData
                        resultData_clock = tmpResultData
                    Case "sk"
                        userNameData_sk = tmpUserNameData
                        resultData_sk = tmpResultData
                    Case "666"
                        userNameData_666 = tmpUserNameData
                        resultData_666 = tmpResultData
                    Case "777"
                        userNameData_777 = tmpUserNameData
                        resultData_777 = tmpResultData
                End Select
            Next
        End Function

        Function sortByAvgResult(userNameArray, resultArray, flag)
            If UBound(resultArray) > 0 Then
                For i = 0 To UBound(resultArray)-1
                    For j = i+1 To UBound(resultArray)
                        If resultArray(i) <> "" And resultArray(j) <> "" Then
                            tmpResultArray1 = Split(resultArray(i), " ")
                            tmpResultArray2 = Split(resultArray(j), " ")

                            tmpResultArray1(flag) = changeResult(tmpResultArray1(flag))
                            tmpResultArray2(flag) = changeResult(tmpResultArray2(flag))

                            If tmpResultArray1(flag) - tmpResultArray2(flag) > 0 Then
                                tmpStr = resultArray(i)
                                resultArray(i) = resultArray(j)
                                resultArray(j) = tmpStr

                                tmpStr = userNameArray(i)
                                userNameArray(i) = userNameArray(j)
                                userNameArray(j) = tmpStr
                            End If
                        Else
                            If resultArray(i) = "" Then
                                resultArray(i) = resultArray(j)
                                resultArray(j) = ""

                                userNameArray(i) = userNameArray(j)
                                userNameArray(j) = ""
                            End If
                        End If
                    Next
                Next
            End If
        End Function

        Function writeAllProjectResult(ExcelSheet, userNameArray, resultArray, projectName)
            Dim strResultArray, rankNum
            rankNum = 0
            countExcelRow = countExcelRow + 1
            For i = 1 To 9
                If i = 1 Then
                    ExcelSheet.Cells(countExcelRow, i).HorizontalAlignment = 2
                ElseIf i = 2 Then
                    ExcelSheet.Cells(countExcelRow, i).HorizontalAlignment = 3
                Else
                    ExcelSheet.Cells(countExcelRow, i).HorizontalAlignment = 4
                End If
                ExcelSheet.Cells(countExcelRow, i).Interior.Color = RGB(0,0,0)
                ExcelSheet.Cells(countExcelRow, i).Font.Color = RGB(255,255,255)
            Next

            ExcelSheet.Cells(countExcelRow, 1).Value = projectName
            ExcelSheet.Cells(countExcelRow, 2).Value = "ID"
            ExcelSheet.Cells(countExcelRow, 3).Value = "最好成绩"
            ExcelSheet.Cells(countExcelRow, 4).Value = "平均成绩"
            ExcelSheet.Cells(countExcelRow, 5).Value = "t1"
            ExcelSheet.Cells(countExcelRow, 6).Value = "t2"
            ExcelSheet.Cells(countExcelRow, 7).Value = "t3"
            ExcelSheet.Cells(countExcelRow, 8).Value = "t4"
            ExcelSheet.Cells(countExcelRow, 9).Value = "t5"

            For i = 0 To UBound(resultArray)
                countExcelRow = countExcelRow + 1
                rankNum = rankNum + 1
                If resultArray(i) <> "" Then
                    strResultArray = Split(resultArray(i), " ")
                Else
                    ReDim strResultArray(4)
                End If

                For j = 1 To 9
                    If j = 2 Then
                        ExcelSheet.Cells(countExcelRow, j).HorizontalAlignment = 2
                    Else
                        ExcelSheet.Cells(countExcelRow, j).HorizontalAlignment = 4
                    End If

                    If j = 4 Then
                        ExcelSheet.Cells(countExcelRow, j).Font.Bold = True
                    End If

                    If j < 3 Then
                        ExcelSheet.Cells(countExcelRow, j).Font.Color = RGB(247,83,9)
                    Else
                        ExcelSheet.Cells(countExcelRow, j).NumberFormat = "@"
                        ExcelSheet.Cells(countExcelRow, j).Font.Color = RGB(0,0,0)
                    End If

                    If isEvenNum(i) Then
                        ExcelSheet.Cells(countExcelRow, j).Interior.Color = RGB(255,255,255)
                    Else
                        ExcelSheet.Cells(countExcelRow, j).Interior.Color = RGB(230,230,230)
                    End If
                Next

                ExcelSheet.Cells(countExcelRow, 1).Value = rankNum
                ExcelSheet.Cells(countExcelRow, 2).Value = userNameArray(i)
                ExcelSheet.Cells(countExcelRow, 3).Value = strResultArray(1)
                ExcelSheet.Cells(countExcelRow, 4).Value = strResultArray(0)
                For j = 2 To UBound(strResultArray)
                    ExcelSheet.Cells(countExcelRow, j+3).Value = strResultArray(j)
                Next
            Next

            countExcelRow = countExcelRow + 1
        End Function



'*************************************************
'*************************************************

Function cutStrWithKey(str, keyBegin, numBegin, keyEnd, numEnd)
    Dim tmpStr, countStart, countEnd
    tmpStr = str
    If keyBegin <> "" Then
        countStart = InStr(tmpStr, keyBegin) + numBegin
    Else
        countStart = 1
    End If
    countEnd = InStr(tmpStr, keyEnd) + numEnd
    tmpStr = Mid(tmpStr, countStart, countEnd-countStart)
    cutStrWithKey = tmpStr
End Function

Function msgboxArray(strArray)
    Dim tmpStr
    For count = 0 To UBound(strArray)
    	tmpStr = tmpStr & " " & strArray(count)
    Next
    Msgbox(tmpStr)
End Function

Function getExistInArray(strArray, str)
    Dim countFinded, count
    countFinded = ""
    For count = 0 To UBound(strArray)
        If str = strArray(count) Then
            countFinded = count
            Exit For
        End If
    Next
    getExistInArray = countFinded
End Function

Function isCharacter(character,characters)
    Dim flag
    flag = False
    If InStr(characters, character) > 0 Then
        flag = True
    End If
    isCharacter = flag
End Function

Function isEvenNum(num)
    Dim flag, tmpNum
    flag = False
    tmpNum = num
    tmpNum = tmpNum / 2
    If tmpNum = Round(tmpNum, 0) Then
        flag = True
    End If
    isEvenNum = flag
End Function

Function getAllProjectName()
    tmpArray = Array("333","444","555","222","333bf","333oh","333fm","mega","py","sq","clock","sk","666","777")
    getAllProjectName = tmpArray
End Function

Function getProjectCheckStrArray(projectName)
    checkStrArray_333 = Array("beginFlag333 ","beginFlag333<br>"," 333 "," 333<",">333 ",">333<","三阶","三速")
    checkStrArray_444 = Array("beginFlag444"," 444",">444","四阶","四速")
    checkStrArray_555 = Array("beginFlag555"," 555",">555","五阶","五速")
    checkStrArray_222 = Array("beginFlag222"," 222",">222","二阶","二速")
    checkStrArray_666 = Array("beginFlag666"," 666",">666","六阶","六速")
    checkStrArray_777 = Array("beginFlag777"," 777",">777","七阶","七速")
    checkStrArray_333bf = Array("三盲","3bf","3bld")
    checkStrArray_333oh = Array("三单","3oh","oh<br>","oh ")
    checkStrArray_333fm = Array("最少步","最小步","3fm","<br>fm"," fm")
    checkStrArray_mega = Array("五魔","mega","七阶","七速")
    checkStrArray_py = Array("塔","py")
    checkStrArray_sq = Array("sq")
    checkStrArray_clock = Array(" 表","<br>表","魔表","clock","clk")
    checkStrArray_sk = Array("斜转","sk")

    Select Case projectName
        Case "333"
            getProjectCheckStrArray = checkStrArray_333
        Case "444"
            getProjectCheckStrArray = checkStrArray_444
        Case "555"
            getProjectCheckStrArray = checkStrArray_555
        Case "222"
            getProjectCheckStrArray = checkStrArray_222
        Case "666"
            getProjectCheckStrArray = checkStrArray_666
        Case "777"
            getProjectCheckStrArray = checkStrArray_777
        Case "333bf"
            getProjectCheckStrArray = checkStrArray_333bf
        Case "333oh"
            getProjectCheckStrArray = checkStrArray_333oh
        Case "333fm"
            getProjectCheckStrArray = checkStrArray_333fm
        Case "mega"
            getProjectCheckStrArray = checkStrArray_mega
        Case "py"
            getProjectCheckStrArray = checkStrArray_py
        Case "sq"
            getProjectCheckStrArray = checkStrArray_sq
        Case "clock"
            getProjectCheckStrArray = checkStrArray_clock
        Case "sk"
            getProjectCheckStrArray = checkStrArray_sk
    End Select
End Function

Function sortIntArray(intString)
    Dim i, j, length, tmpStr, tmpArray
    tmpArray = intString
    length = UBound(tmpArray)
    For i=0 to length-1
        For j=i+1 to length
            If (tmpArray(i) - tmpArray(j)) > 0 Then
                tmpStr = tmpArray(i)
                tmpArray(i) = tmpArray(j)
                tmpArray(j) = tmpStr
            End If
        Next
    Next
    sortIntArray = tmpArray
End Function

Function changeResult(result)
    Dim tmpStr
    tmpStr = result
    If tmpStr <> "DNF" And tmpStr <> "" Then
        colonInStr = InStr(tmpStr, ":")
        If colonInStr > 1 Then
            tmpStr = Mid(tmpStr, 1, colonInStr-1) * 60 + Mid(tmpStr, colonInStr+1)
        ElseIf colonInStr = 1 Then
            tmpStr = RePlace(tmpStr, ":", "")
        End If
        tmpStr = FormatNumber(tmpStr, 2, , , 0)
    ElseIf tmpStr = "DNF" Then
        tmpStr = 9999.99
    End If

    changeResult = tmpStr
End Function

Function revertResult(result)
    Dim tmpStr, minNum, secNum
    tmpStr = result
    If tmpStr = 9999.99 Then
        tmpStr = "DNF"
    ElseIf tmpStr > 59.99 Then
        minNum = int(tmpStr / 60)
        secNum = FormatNumber(tmpStr - minNum * 60, 2, , , 0)
        If secNum < 10.00 Then
            secNum = "0" & secNum
        End If
        tmpStr = minNum & ":" & secNum
    End If
    
    revertResult = tmpStr
End Function




''''''''''''''''''''''''''''''''''''''











Function addProjectName(projectName)
    countResultData = countResultData + 1
    ReDim Preserve userNameData(countResultData)
    ReDim Preserve resultData(countResultData)
    userNameData(countResultData-1) = ""
    resultData(countResultData-1) = ""
    userNameData(countResultData) = projectName
    resultData(countResultData) = ""
    countResultData = countResultData + 1
End Function



</Script>
</Body>
</Html>
